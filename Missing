<?php
/**
 * Plugin Name: Missing Product WooCommerce Alternative
 * Description: Handles missing items, alternatives, and customer responses for WooCommerce orders.
 */

if ( ! defined( 'ABSPATH' ) ) {
    exit;
}

class LP_Missing_Product_Handler {
    const META_KEY = '_lp_missing_data';
    const OPTION_ENABLE_STOCK = 'lp_missing_enable_stock_log';
    const AJAX_NONCE_ACTION = 'lp_missing_admin';
    const SHORTCODE = 'lp_missing_items';

    public static function init() {
        add_action( 'add_meta_boxes', array( __CLASS__, 'add_metabox' ) );
        add_action( 'save_post_shop_order', array( __CLASS__, 'save_metabox' ), 10, 2 );
        add_action( 'admin_enqueue_scripts', array( __CLASS__, 'enqueue_admin_scripts' ) );
        add_action( 'wp_ajax_lp_missing_search_products', array( __CLASS__, 'ajax_search_products' ) );
        add_action( 'wp_ajax_lp_missing_preview_product', array( __CLASS__, 'ajax_preview_product' ) );
        add_shortcode( self::SHORTCODE, array( __CLASS__, 'render_shortcode' ) );
    }

    public static function add_metabox() {
        add_meta_box(
            'lp_missing_metabox',
            __( 'Missing / Problem Items', 'lp-missing' ),
            array( __CLASS__, 'render_metabox' ),
            'shop_order',
            'normal',
            'high'
        );
    }

    protected static function default_item_data() {
        return array(
            'missing'         => false,
            'propose_delete'  => false,
            'qty_missing'     => 0,
            'notes'           => '',
            'internal_notes'  => '',
            'alternatives'    => array(),
            'status'          => 'pending',
            'selected_alt_id' => 0,
            'qty_alt'         => 0,
            'stock_locked_qty'=> 0,
            'last_updated'    => 0,
        );
    }

    protected static function get_item_data( $item ) {
        $data = $item->get_meta( self::META_KEY, true );
        if ( ! is_array( $data ) ) {
            $data = array();
        }

        $data = wp_parse_args( $data, self::default_item_data() );
        $data['missing'] = (bool) $data['missing'];
        $data['propose_delete'] = (bool) $data['propose_delete'];
        $data['qty_missing'] = absint( $data['qty_missing'] );
        $data['alternatives'] = is_array( $data['alternatives'] ) ? array_values( array_unique( array_map( 'absint' , $data['alternatives'] ) ) ) : array();
        $data['selected_alt_id'] = absint( $data['selected_alt_id'] );
        $data['qty_alt'] = absint( $data['qty_alt'] );
        $data['stock_locked_qty'] = absint( $data['stock_locked_qty'] );
        $data['last_updated'] = absint( $data['last_updated'] );

        return $data;
    }

    public static function render_metabox( $post ) {
        $order = wc_get_order( $post->ID );
        if ( ! $order ) {
            return;
        }

        wp_nonce_field( 'lp_missing_metabox', 'lp_missing_nonce' );
        $items = $order->get_items( 'line_item' );
        $product_cache = array();
        $alt_ids = array();
        foreach ( $items as $item ) {
            $data = self::get_item_data( $item );
            if ( ! empty( $data['alternatives'] ) ) {
                $alt_ids = array_merge( $alt_ids, $data['alternatives'] );
            }
        }
        if ( $alt_ids ) {
            $products = wc_get_products( array( 'include' => array_values( array_unique( $alt_ids ) ), 'limit' => -1 ) );
            foreach ( $products as $product_obj ) {
                $product_cache[ $product_obj->get_id() ] = $product_obj;
            }
        }

        echo '<div class="lp-missing-metabox">';
        foreach ( $items as $item_id => $item ) {
            $data = self::get_item_data( $item );
            $product = $item->get_product();
            $product_name = $product ? $product->get_name() : $item->get_name();
            $alt_list = ! empty( $data['alternatives'] ) ? implode( ',', $data['alternatives'] ) : '';
            echo '<div class="lp-missing-item" style="border-bottom:1px solid #ddd;padding:10px 0;">';
            echo '<strong>' . esc_html( $product_name ) . '</strong> (' . sprintf( __( 'Qty: %s', 'lp-missing' ), esc_html( $item->get_quantity() ) ) . ')';
            echo '<div style="margin-top:8px;">';
            echo '<label><input type="checkbox" name="lp_missing_items[' . absint( $item_id ) . '][missing]" value="1" ' . checked( true, $data['missing'], false ) . ' /> ' . esc_html__( 'Mark as missing', 'lp-missing' ) . '</label> ';
            echo '<label style="margin-left:12px;"><input type="checkbox" name="lp_missing_items[' . absint( $item_id ) . '][propose_delete]" value="1" ' . checked( true, $data['propose_delete'], false ) . ' /> ' . esc_html__( 'Propose deleting this item instead', 'lp-missing' ) . '</label>';
            echo '</div>';

            echo '<div style="margin-top:8px;">';
            echo '<label>' . esc_html__( 'Quantity missing', 'lp-missing' ) . ': <input type="number" min="0" name="lp_missing_items[' . absint( $item_id ) . '][qty_missing]" value="' . esc_attr( $data['qty_missing'] ) . '" style="width:80px;" /></label>';
            echo '</div>';

            echo '<div style="margin-top:8px;">';
            echo '<label>' . esc_html__( 'Notes (customer visible)', 'lp-missing' ) . '<br /><textarea name="lp_missing_items[' . absint( $item_id ) . '][notes]" rows="2" style="width:100%;">' . esc_textarea( $data['notes'] ) . '</textarea></label>';
            echo '</div>';

            echo '<div style="margin-top:8px;">';
            echo '<label>' . esc_html__( 'Internal notes (staff only)', 'lp-missing' ) . '<br /><textarea name="lp_missing_items[' . absint( $item_id ) . '][internal_notes]" rows="2" style="width:100%;">' . esc_textarea( $data['internal_notes'] ) . '</textarea></label>';
            echo '</div>';

            echo '<div style="margin-top:8px;" class="lp-missing-alternatives" data-item-id="' . absint( $item_id ) . '">';
            echo '<label>' . esc_html__( 'Suggested alternatives (IDs, up to 3)', 'lp-missing' ) . '</label><br />';
            echo '<input type="hidden" class="lp-alt-ids" name="lp_missing_items[' . absint( $item_id ) . '][alternatives]" value="' . esc_attr( $alt_list ) . '" />';
            echo '<input type="text" class="lp-alt-search" placeholder="' . esc_attr__( 'Search by SKU or title', 'lp-missing' ) . '" />';
            echo '<ul class="lp-alt-list" style="margin:8px 0 0; padding-left:18px;">';
            if ( ! empty( $data['alternatives'] ) ) {
                foreach ( $data['alternatives'] as $alt_id ) {
                    $alt_product = isset( $product_cache[ $alt_id ] ) ? $product_cache[ $alt_id ] : wc_get_product( $alt_id );
                    if ( ! $alt_product ) {
                        continue;
                    }
                    echo '<li data-product-id="' . absint( $alt_id ) . '" style="margin-bottom:6px;">';
                    echo esc_html( $alt_product->get_name() ) . ' (ID: ' . absint( $alt_id ) . ')';
                    echo '<span class="lp-alt-preview" style="margin-left:6px; font-size:11px; color:#555;"></span> ';
                    echo '<a href="#" class="lp-alt-remove" aria-label="' . esc_attr__( 'Remove', 'lp-missing' ) . '">[' . esc_html__( 'Remove', 'lp-missing' ) . ']</a>';
                    echo '</li>';
                }
            }
            echo '</ul>';
            echo '</div>';
            echo '</div>';
        }
        echo '</div>';
    }

    public static function enqueue_admin_scripts( $hook ) {
        if ( 'post.php' !== $hook && 'post-new.php' !== $hook ) {
            return;
        }
        $screen = get_current_screen();
        if ( empty( $screen->post_type ) || 'shop_order' !== $screen->post_type ) {
            return;
        }

        wp_register_script( 'lp-missing-admin', '', array( 'jquery' ), '1.0', true );
        $inline = <<<'JS'
(function($){
    function updateInput($container){
        var ids=[];
        $container.find('.lp-alt-list li').each(function(){
            var id=$(this).data('product-id');
            if(id){ids.push(id);}
        });
        $container.find('.lp-alt-ids').val(ids.join(','));
    }
    function renderPreview($el,id){
        if(!id){return;}
        $.get(ajaxurl,{action:'lp_missing_preview_product',nonce:lpMissingAdmin.nonce,product_id:id},function(resp){
            if(resp && resp.success && resp.data){
                var d=resp.data;
                var text=(d.thumbnail?"<img src='"+d.thumbnail+"' style=\"width:20px;height:20px;object-fit:cover;margin-right:4px;vertical-align:middle;\" />":"");
                text+='<span>'+d.title+' | '+(d.sku?'SKU: '+d.sku+' | ':'')+(d.in_stock?'In stock':'Out of stock');
                if(null!==d.stock_quantity){text+=' ('+d.stock_quantity+')';}
                text+='</span>';
                $el.html(text);
            }
        });
    }
    $(document).on('keypress','.lp-alt-search',function(e){
        if(13===e.which){e.preventDefault();}
    });
    $(document).on('input','.lp-alt-search',function(){
        var $input=$(this);var term=$.trim($input.val());
        var $container=$input.closest('.lp-missing-alternatives');
        if(term.length<2){return;}
        $.get(ajaxurl,{action:'lp_missing_search_products',nonce:lpMissingAdmin.nonce,term:term},function(resp){
            if(resp && resp.success && resp.data && resp.data.length){
                var existing=$container.find('.lp-alt-list li').length;
                if(existing>=3){return;}
                var item=resp.data[0];
                var exists=false;
                $container.find('.lp-alt-list li').each(function(){if($(this).data('product-id')==item.id){exists=true;}});
                if(exists){return;}
                var $li=$('<li data-product-id="'+item.id+'"></li>');
                $li.append(document.createTextNode(item.title+' (ID: '+item.id+')'));
                $li.append(" <span class='lp-alt-preview' style='margin-left:6px;font-size:11px;color:#555;'></span> ");
                $li.append("<a href='#' class='lp-alt-remove'>["+lpMissingAdmin.removeLabel+"]</a>");
                $container.find('.lp-alt-list').append($li);
                renderPreview($li.find('.lp-alt-preview'),item.id);
                updateInput($container);
            }
        });
    });
    $(document).on('click','.lp-alt-remove',function(e){e.preventDefault();var $container=$(this).closest('.lp-missing-alternatives');$(this).closest('li').remove();updateInput($container);});
    $('.lp-alt-list li').each(function(){var $li=$(this);renderPreview($li.find('.lp-alt-preview'),$li.data('product-id'));});
})(jQuery);
JS;
        wp_add_inline_script( 'lp-missing-admin', $inline );


        wp_localize_script( 'lp-missing-admin', 'lpMissingAdmin', array(
            'nonce'        => wp_create_nonce( self::AJAX_NONCE_ACTION ),
            'removeLabel'  => esc_html__( 'Remove', 'lp-missing' ),
        ) );
        wp_enqueue_script( 'lp-missing-admin' );
    }

    protected static function sanitize_alt_ids( $input ) {
        if ( ! is_string( $input ) ) {
            return array();
        }
        $parts = preg_split( '/[,\s]+/', $input );
        $ids = array();
        foreach ( $parts as $part ) {
            $id = absint( $part );
            if ( $id > 0 ) {
                $ids[] = $id;
            }
        }
        $ids = array_slice( array_values( array_unique( $ids ) ), 0, 3 );
        return $ids;
    }

    protected static function stock_lock_enabled() {
        $enabled = get_option( self::OPTION_ENABLE_STOCK, 'yes' );
        return apply_filters( 'lp_missing_enable_stock_log', 'yes' === $enabled );
    }

    public static function save_metabox( $post_id, $post ) {
        if ( ! isset( $_POST['lp_missing_nonce'] ) || ! wp_verify_nonce( sanitize_text_field( wp_unslash( $_POST['lp_missing_nonce'] ) ), 'lp_missing_metabox' ) ) {
            return;
        }
        if ( ! current_user_can( 'edit_shop_order', $post_id ) ) {
            return;
        }
        if ( empty( $_POST['lp_missing_items'] ) || ! is_array( $_POST['lp_missing_items'] ) ) {
            return;
        }

        $order = wc_get_order( $post_id );
        if ( ! $order ) {
            return;
        }

        $items = $order->get_items( 'line_item' );
        foreach ( $items as $item_id => $item ) {
            $existing = self::get_item_data( $item );
            $posted   = isset( $_POST['lp_missing_items'][ $item_id ] ) && is_array( $_POST['lp_missing_items'][ $item_id ] ) ? $_POST['lp_missing_items'][ $item_id ] : array();

            $missing = ! empty( $posted['missing'] );
            $propose_delete = ! empty( $posted['propose_delete'] );
            $qty_missing = isset( $posted['qty_missing'] ) ? max( 0, absint( $posted['qty_missing'] ) ) : 0;
            $notes = isset( $posted['notes'] ) ? wp_kses_post( wp_unslash( $posted['notes'] ) ) : '';
            $internal_notes = isset( $posted['internal_notes'] ) ? wp_kses_post( wp_unslash( $posted['internal_notes'] ) ) : '';
            $alt_ids = isset( $posted['alternatives'] ) ? self::sanitize_alt_ids( wp_unslash( $posted['alternatives'] ) ) : array();

            $new_data = $existing;
            $new_data['missing'] = $missing;
            $new_data['propose_delete'] = $missing && $propose_delete;
            $new_data['qty_missing'] = $missing ? $qty_missing : 0;
            $new_data['notes'] = $missing ? $notes : '';
            $new_data['internal_notes'] = $missing ? $internal_notes : '';
            $new_data['alternatives'] = $missing ? $alt_ids : array();
            if ( ! $missing ) {
                $new_data['status'] = 'cleared';
                $new_data['selected_alt_id'] = 0;
                $new_data['qty_alt'] = 0;
            }

            $new_data['last_updated'] = time();

            self::maybe_adjust_stock( $item, $existing, $new_data, $order );

            if ( serialize( $existing ) !== serialize( $new_data ) ) {
                $item->update_meta_data( self::META_KEY, $new_data );
                $item->save();
                do_action( 'lp_missing_item_updated', $order, $item_id, $new_data, $existing );
            } else {
                $item->update_meta_data( self::META_KEY, $new_data );
                $item->save();
            }
        }
    }

    protected static function maybe_adjust_stock( $item, $existing, &$new_data, $order ) {
        if ( ! self::stock_lock_enabled() ) {
            $new_data['stock_locked_qty'] = $new_data['qty_missing'];
            return;
        }
        $product = $item->get_product();
        if ( ! $product || ! $product->managing_stock() ) {
            $new_data['stock_locked_qty'] = $new_data['qty_missing'];
            return;
        }

        $previous_lock = isset( $existing['stock_locked_qty'] ) ? absint( $existing['stock_locked_qty'] ) : 0;
        $new_lock      = $new_data['qty_missing'];
        $delta         = $new_lock - $previous_lock;
        if ( 0 === $delta ) {
            $new_data['stock_locked_qty'] = $new_lock;
            return;
        }

        if ( $delta > 0 ) {
            wc_update_product_stock( $product, $delta, 'decrease' );
            $order->add_order_note( sprintf( __( 'Inventory decreased by %1$s for product %2$s. Reason: Missing-item stock lock delta.', 'lp-missing' ), $delta, $product->get_name() ) );
        } else {
            wc_update_product_stock( $product, abs( $delta ), 'increase' );
            $order->add_order_note( sprintf( __( 'Inventory increased by %1$s for product %2$s. Reason: Missing-item stock lock delta.', 'lp-missing' ), abs( $delta ), $product->get_name() ) );
        }
        $new_data['stock_locked_qty'] = $new_lock;
    }

    public static function ajax_search_products() {
        if ( ! current_user_can( 'edit_shop_orders' ) ) {
            wp_send_json_error();
        }
        $nonce = isset( $_GET['nonce'] ) ? sanitize_text_field( wp_unslash( $_GET['nonce'] ) ) : '';
        if ( ! wp_verify_nonce( $nonce, self::AJAX_NONCE_ACTION ) ) {
            wp_send_json_error();
        }
        $term = isset( $_GET['term'] ) ? sanitize_text_field( wp_unslash( $_GET['term'] ) ) : '';
        if ( strlen( $term ) < 2 ) {
            wp_send_json_success( array() );
        }

        $query = new WP_Query( array(
            'post_type'      => array( 'product', 'product_variation' ),
            'post_status'    => array( 'publish', 'private' ),
            'posts_per_page' => 15,
            'fields'         => 'ids',
            's'              => $term,
            'meta_query'     => array(
                'relation' => 'OR',
                array(
                    'key'     => '_sku',
                    'value'   => $term,
                    'compare' => 'LIKE',
                ),
            ),
        ) );

        $results = array();
        if ( $query->have_posts() ) {
            $products = wc_get_products( array( 'include' => $query->posts, 'limit' => 15 ) );
            foreach ( $products as $product ) {
                $results[] = array(
                    'id'    => $product->get_id(),
                    'title' => $product->get_name(),
                );
            }
        }

        wp_send_json_success( $results );
    }

    public static function ajax_preview_product() {
        if ( ! current_user_can( 'edit_shop_orders' ) ) {
            wp_send_json_error();
        }
        $nonce = isset( $_GET['nonce'] ) ? sanitize_text_field( wp_unslash( $_GET['nonce'] ) ) : '';
        if ( ! wp_verify_nonce( $nonce, self::AJAX_NONCE_ACTION ) ) {
            wp_send_json_error();
        }
        $product_id = isset( $_GET['product_id'] ) ? absint( $_GET['product_id'] ) : 0;
        if ( ! $product_id ) {
            wp_send_json_error();
        }
        $product = wc_get_product( $product_id );
        if ( ! $product ) {
            wp_send_json_error();
        }
        $data = array(
            'id'             => $product->get_id(),
            'title'          => $product->get_name(),
            'sku'            => $product->get_sku(),
            'in_stock'       => $product->is_in_stock(),
            'stock_quantity' => $product->managing_stock() ? $product->get_stock_quantity() : null,
            'thumbnail'      => wp_get_attachment_image_url( $product->get_image_id(), 'thumbnail' ),
        );
        wp_send_json_success( $data );
    }

    protected static function get_order_for_shortcode( $atts ) {
        $order_id = isset( $atts['order_id'] ) ? absint( $atts['order_id'] ) : 0;
        $email    = isset( $atts['email'] ) ? sanitize_email( $atts['email'] ) : '';
        if ( ! $order_id || ! $email ) {
            return array( null, '' );
        }
        $order = wc_get_order( $order_id );
        if ( ! $order ) {
            return array( null, '' );
        }
        if ( strtolower( $order->get_billing_email() ) !== strtolower( $email ) ) {
            return array( null, '' );
        }
        return array( $order, $email );
    }

    protected static function rate_limit_key( $order_id, $email ) {
        return 'lp_missing_rate_' . $order_id . '_' . md5( strtolower( $email ) );
    }

    protected static function handle_portal_action( $order, $email ) {
        if ( empty( $_POST['lp_missing_action'] ) || empty( $_POST['lp_missing_nonce'] ) ) {
            return array( 'message' => '', 'status' => '' );
        }
        if ( ! wp_verify_nonce( sanitize_text_field( wp_unslash( $_POST['lp_missing_nonce'] ) ), 'lp_missing_portal_' . $order->get_id() ) ) {
            return array( 'message' => __( 'Security check failed.', 'lp-missing' ), 'status' => 'error' );
        }
        $key = self::rate_limit_key( $order->get_id(), $email );
        $count = (int) get_transient( $key );
        if ( $count >= 5 ) {
            return array( 'message' => __( 'Too many actions. Please wait and try again.', 'lp-missing' ), 'status' => 'error' );
        }
        set_transient( $key, $count + 1, MINUTE_IN_SECONDS );

        $action    = sanitize_text_field( wp_unslash( $_POST['lp_missing_action'] ) );
        $item_id   = isset( $_POST['lp_missing_item_id'] ) ? absint( $_POST['lp_missing_item_id'] ) : 0;
        $items     = $order->get_items( 'line_item' );
        $item      = isset( $items[ $item_id ] ) ? $items[ $item_id ] : null;
        if ( ! $item ) {
            return array( 'message' => __( 'Invalid item selected.', 'lp-missing' ), 'status' => 'error' );
        }

        $existing = self::get_item_data( $item );
        if ( empty( $existing['missing'] ) ) {
            return array( 'message' => __( 'Item is not marked as missing.', 'lp-missing' ), 'status' => 'error' );
        }

        $new = $existing;
        $new['last_updated'] = time();

        if ( 'accept_alt' === $action ) {
            $alt_id = isset( $_POST['lp_missing_alt_id'] ) ? absint( $_POST['lp_missing_alt_id'] ) : 0;
            $qty_alt = isset( $_POST['lp_missing_alt_qty'] ) ? absint( $_POST['lp_missing_alt_qty'] ) : 0;
            if ( $qty_alt < 1 || $qty_alt > $existing['qty_missing'] ) {
                return array( 'message' => __( 'Invalid quantity selected.', 'lp-missing' ), 'status' => 'error' );
            }
            if ( ! in_array( $alt_id, $existing['alternatives'], true ) ) {
                return array( 'message' => __( 'Alternative not allowed.', 'lp-missing' ), 'status' => 'error' );
            }
            $new['status'] = 'alt_accepted';
            $new['selected_alt_id'] = $alt_id;
            $new['qty_alt'] = $qty_alt;
        } elseif ( 'decline_all' === $action ) {
            $new['status'] = 'declined';
            $new['selected_alt_id'] = 0;
            $new['qty_alt'] = 0;
        } elseif ( 'accept_delete' === $action ) {
            if ( empty( $existing['propose_delete'] ) ) {
                return array( 'message' => __( 'Deletion not available for this item.', 'lp-missing' ), 'status' => 'error' );
            }
            $new['status'] = 'delete_accepted';
        } else {
            return array( 'message' => __( 'Unknown action.', 'lp-missing' ), 'status' => 'error' );
        }

        if ( serialize( $existing ) !== serialize( $new ) ) {
            $item->update_meta_data( self::META_KEY, $new );
            $item->save();
            do_action( 'lp_missing_item_updated', $order, $item_id, $new, $existing );
        }

        return array( 'message' => __( 'Your choice has been saved.', 'lp-missing' ), 'status' => 'success' );
    }

    public static function render_shortcode( $atts ) {
        $atts = shortcode_atts( array(
            'order_id' => 0,
            'email'    => '',
        ), $atts, self::SHORTCODE );

        list( $order, $email ) = self::get_order_for_shortcode( $atts );
        if ( ! $order ) {
            return '<div class="lp-missing-portal-error">' . esc_html__( 'Order not found or email does not match.', 'lp-missing' ) . '</div>';
        }

        $response = self::handle_portal_action( $order, $email );
        $items    = $order->get_items( 'line_item' );
        $missing_items = array();
        $alt_ids = array();
        foreach ( $items as $item_id => $item ) {
            $data = self::get_item_data( $item );
            if ( ! empty( $data['missing'] ) ) {
                $missing_items[ $item_id ] = array( 'item' => $item, 'data' => $data );
                if ( ! empty( $data['alternatives'] ) ) {
                    $alt_ids = array_merge( $alt_ids, $data['alternatives'] );
                }
            }
        }
        if ( empty( $missing_items ) ) {
            return '<div class="lp-missing-portal-empty">' . esc_html__( 'No missing items on this order.', 'lp-missing' ) . '</div>';
        }

        $alt_products = array();
        if ( $alt_ids ) {
            $products = wc_get_products( array( 'include' => array_values( array_unique( $alt_ids ) ), 'limit' => -1 ) );
            foreach ( $products as $product_obj ) {
                $alt_products[ $product_obj->get_id() ] = $product_obj;
            }
        }

        ob_start();
        if ( ! empty( $response['message'] ) ) {
            $class = 'success' === $response['status'] ? 'lp-message-success' : 'lp-message-error';
            echo '<div class="' . esc_attr( $class ) . '">' . esc_html( $response['message'] ) . '</div>';
        }
        echo '<div class="lp-missing-portal">';
        foreach ( $missing_items as $item_id => $payload ) {
            $item = $payload['item'];
            $data = $payload['data'];
            $product = $item->get_product();
            $product_name = $product ? $product->get_name() : $item->get_name();
            echo '<div class="lp-portal-item" style="border:1px solid #ddd;padding:10px;margin-bottom:12px;">';
            echo '<strong>' . esc_html( $product_name ) . '</strong>'; 
            echo '<div>' . sprintf( esc_html__( 'Ordered: %1$s | Missing: %2$s', 'lp-missing' ), esc_html( $item->get_quantity() ), esc_html( $data['qty_missing'] ) ) . '</div>';
            if ( ! empty( $data['notes'] ) ) {
                echo '<div>' . esc_html( $data['notes'] ) . '</div>';
            }
            if ( ! empty( $data['alternatives'] ) ) {
                echo '<div><em>' . esc_html__( 'Suggested alternatives:', 'lp-missing' ) . '</em><ul style="margin:6px 0 0; padding-left:18px;">';
                foreach ( $data['alternatives'] as $alt_id ) {
                    $alt_product = isset( $alt_products[ $alt_id ] ) ? $alt_products[ $alt_id ] : wc_get_product( $alt_id );
                    if ( ! $alt_product ) {
                        continue;
                    }
                    echo '<li>';
                    echo '<a href="' . esc_url( get_permalink( $alt_product->get_id() ) ) . '" target="_blank" rel="noopener noreferrer">' . esc_html( $alt_product->get_name() ) . '</a>';
                    $sku = $alt_product->get_sku();
                    if ( $sku ) {
                        echo ' <small>(' . esc_html( $sku ) . ')</small>';
                    }
                    echo '</li>';
                }
                echo '</ul></div>';
            }

            echo '<form method="post" style="margin-top:8px;">';
            wp_nonce_field( 'lp_missing_portal_' . $order->get_id(), 'lp_missing_nonce' );
            echo '<input type="hidden" name="lp_missing_item_id" value="' . absint( $item_id ) . '" />';

            if ( ! empty( $data['alternatives'] ) ) {
                echo '<div style="margin-bottom:8px;">';
                echo '<label>' . esc_html__( 'Choose an alternative:', 'lp-missing' ) . ' ';
                echo '<select name="lp_missing_alt_id">';
                foreach ( $data['alternatives'] as $alt_id ) {
                    $alt_product = isset( $alt_products[ $alt_id ] ) ? $alt_products[ $alt_id ] : wc_get_product( $alt_id );
                    if ( ! $alt_product ) {
                        continue;
                    }
                    echo '<option value="' . absint( $alt_id ) . '">' . esc_html( $alt_product->get_name() ) . '</option>';
                }
                echo '</select></label> ';
                echo '<label>' . esc_html__( 'Quantity', 'lp-missing' ) . ' <input type="number" min="1" max="' . esc_attr( $data['qty_missing'] ) . '" name="lp_missing_alt_qty" value="' . esc_attr( $data['qty_missing'] ) . '" style="width:70px;" /></label> ';
                echo '<button type="submit" name="lp_missing_action" value="accept_alt">' . esc_html__( 'Accept alternative', 'lp-missing' ) . '</button>';
                echo '</div>';
            }

            echo '<div style="margin-bottom:8px;">';
            echo '<button type="submit" name="lp_missing_action" value="decline_all">' . esc_html__( 'Decline all alternatives', 'lp-missing' ) . '</button>';
            echo '</div>';

            if ( ! empty( $data['propose_delete'] ) ) {
                echo '<div style="margin-bottom:8px;">';
                echo '<button type="submit" name="lp_missing_action" value="accept_delete">' . esc_html__( 'Accept deletion of this item', 'lp-missing' ) . '</button>';
                echo '</div>';
            }
            echo '</form>';

            echo '</div>';
        }
        echo '</div>';
        return ob_get_clean();
    }
}

LP_Missing_Product_Handler::init();
